<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>XX电商·运营后台·订单录入与销售看板</title>
    <style>
        body { font-family: Arial, sans-serif; }
        .box { border: 1px solid #ddd; padding: 10px; margin: 10px 0; }
        .clock { font-size: 20px; font-weight: bold; color: #336699; }
        label { display: inline-block; width: 120px; }
        table { border-collapse: collapse; width: 100%; margin-top: 10px; }
        th, td { border: 1px solid #ccc; padding: 4px 8px; text-align: center; }
    </style>
</head>
<body>
    <!-- 时钟显示区域 -->
    <div class="clock" id="clock"></div>

    <!-- 订单录入表单 -->
    <div class="box">
        <h2>新建订单</h2>
        <form onsubmit="return validateForm()">
            <p>
                <label for="customerName">客户名称:</label>
                <input type="text" id="customerName" name="customerName">
            </p>
            <p>
                <label for="priceInput">商品单价 (¥):</label>
                <input type="text" id="priceInput" name="priceInput">
            </p>
            <p>
                <label for="qtyInput">数量(件):</label>
                <input type="text" id="qtyInput" name="qtyInput">
            </p>
            <p>
                <label for="customerType">客户类型:</label>
                <select id="customerType" name="customerType">
                    <option value="normal">普通客户</option>
                    <option value="vip">VIP客户</option>
                </select>
            </p>
            <p>
                <label for="urgentFlag">加急发货:</label>
                <input type="checkbox" id="urgentFlag" name="urgentFlag"> 是
            </p>
            <p>
                <button type="submit">添加订单</button>
            </p>
        </form>
    </div>

    <!-- 订单结果显示区域 -->
    <div class="box" id="orderResult"></div>

    <!-- 销售看板与历史订单表格 -->
    <div class="box">
        <h2>销售看板</h2>
        <div id="dashboard"></div>
        <h3>历史订单</h3>
        <div id="orderTable"></div>
    </div>

    <script>
        // 存储所有订单的数组
        var orders = [];

        // 一、折扣与加价政策提示（使用document.write()）
        document.write("<h1>XX电商·运营后台·订单录入与销售看板</h1>");
        document.write("<p>欢迎使用内部工具, 实时查看订单与销售情况。</p>");
        document.write(`
            <div style="padding:12px; background:#eef9ff; border-left:5px solid #3aa0e6; margin:10px 0;">
                <strong>温馨提示: 本店当前可享受的优惠与加价政策如下:</strong>
                <ul style="margin:8px 0 0 20px; line-height:1.6;">
                    <li>VIP 客户享受<strong>9 折优惠</strong></li>
                    <li>加急发货价格会<strong>×1.1</strong></li>
                    <li>每小时前10 分钟再享 <strong>8.5 折</strong></li>
                </ul>
            </div>
        `);

        // 二、模拟时钟+时段折扣提醒
        // 补零函数（格式化时间）
        function padZero(n) {
            return n < 10 ? "0" + n : n;
        }

        // 更新时钟函数
        function updateClock() {
            var now = new Date();
            var y = now.getFullYear();
            var m = now.getMonth() + 1; // 月份从0开始，需+1
            var d = now.getDate();
            var hh = now.getHours();
            var mm = now.getMinutes();
            var ss = now.getSeconds();
            var weekNames = ["日", "一", "二", "三", "四", "五", "六"];
            var w = weekNames[now.getDay()]; // getDay()返回0-6，对应周日-周六
            var timeStr = `${y}年${padZero(m)}月${padZero(d)}日 星期${w} ${padZero(hh)}:${padZero(mm)}:${padZero(ss)}`;
            document.getElementById("clock").innerHTML = timeStr;
        }

        // 页面加载时执行一次时钟，之后每1秒更新一次
        updateClock();
        setInterval(updateClock, 1000);

        // 时段折扣提醒（每小时前10分钟/后50分钟提示）
        var nowForBanner = new Date();
        var minuteForBanner = nowForBanner.getMinutes();
        if (minuteForBanner >= 0 && minuteForBanner <= 9) {
            document.write(`
                <div style="padding:12px; background:#fffbe6; border-left:5px solid #f4d06f; margin:10px 0;">
                    当前为前 10 分钟! 本单可额外享受<strong>8.5 折</strong>时段优惠!
                </div>
            `);
        } else {
            document.write(`
                <div style="padding:12px; background:#f5f5f5; border-left:5px solid #ccc; margin:10px 0;">
                    小贴士:每个整点前10 分钟享受 8.5 折优惠,请留意下单时间~
                </div>
            `);
        }

        // 三、错误数据拦截（表单校验）
        function validateForm() {
            // 获取表单输入值
            var nameStr = document.getElementById("customerName").value;
            var priceStr = document.getElementById("priceInput").value;
            var qtyStr = document.getElementById("qtyInput").value;
            var typeStr = document.getElementById("customerType").value;
            var urgentChecked = document.getElementById("urgentFlag").checked;
            var valid = true;

            // 1. 客户名称校验（不能为空）
            if (nameStr == null || nameStr.trim() === "") {
                alert("客户名称不能为空!");
                valid = false;
            }

            // 2. 商品单价校验（必须是大于0的数字）
            var price = parseFloat(priceStr);
            if (isNaN(price) || price <= 0) {
                alert("商品单价必须是大于 0 的数字!");
                valid = false;
            }

            // 3. 数量校验（必须是大于0的整数）
            var qty = parseInt(qtyStr, 10);
            if (isNaN(qty) || qty <= 0) {
                alert("数量必须是大于0 的整数!");
                valid = false;
            }

            // 校验失败提示
            if (!valid) {
                document.getElementById("orderResult").innerHTML = "<p>订单录入失败, 请检查输入。</p>";
                return false;
            }

            // 校验成功，处理订单（传递参数：客户名称、单价、数量、是否VIP、是否加急）
            processOrder(nameStr.trim(), price, qty, typeStr === "vip", urgentChecked);
            return false; // 阻止表单默认提交行为
        }

        // 四、折扣与加价计算（核心难点，已适配学号末位7特殊逻辑）
        function processOrder(customerName, price, quantity, isVip, isUrgent) {
            // 1. 基础计算（通用逻辑）
            var baseTotal = price * quantity; // 基础总价（单价×数量）
            var afterVip = isVip ? baseTotal * 0.9 : baseTotal; // VIP 9折
            var afterUrgent = isUrgent ? afterVip * 1.1 : afterVip; // 加急×1.1
            var now = new Date();
            var minute = now.getMinutes();
            var hitTimeDiscount = false;
            var finalTotal = afterUrgent;

            // 2. 时段折扣（每小时前10分钟8.5折）
            if (minute >= 0 && minute <= 9) {
                finalTotal *= 0.85;
                hitTimeDiscount = true;
            }

            // 3. 学号末位7 特殊逻辑（重点适配）
            // 条件：VIP 且 没有享受到时间折扣 → 额外9.5折补偿
            var studentIdLastDigit = 7; // 已固定为学号末位7，无需修改
            if (isVip && !hitTimeDiscount) {
                finalTotal *= 0.95;
            }

            // 4. 组装优惠详情HTML（新增末位7优惠提示，直观可见）
            var tipsHtml = "<ul>";
            tipsHtml += isVip ? "<li>VIP 9折已应用</li>" : "<li>普通客户无VIP 优惠</li>";
            tipsHtml += isUrgent ? "<li>加急 ×1.1 已应用</li>" : "<li>未加急</li>";
            tipsHtml += hitTimeDiscount ? "<li>命中前10分钟 ×0.85</li>" : "<li>无时段折扣</li>";
            tipsHtml += isVip && !hitTimeDiscount ? "<li>学号末位7：VIP无时段折扣补偿 ×0.95</li>" : "";
            tipsHtml += "</ul>";

            // 5. 显示订单结果
            var isImportant = isVip && finalTotal > 1000;
            document.getElementById("orderResult").innerHTML = `
                <h3>订单录入成功:</h3>
                <p>客户名称: ${customerName}</p>
                <p>基础金额: ¥${baseTotal.toFixed(2)}</p>
                <p>VIP 后: ¥${afterVip.toFixed(2)}</p>
                <p>加急后: ¥${afterUrgent.toFixed(2)}</p>
                <p>最终金额: ¥${finalTotal.toFixed(2)}</p>
                <p>订单类型: ${isImportant ? "大额 VIP" : "普通订单"}</p>
                <div style='background:#eef; padding:8px; '>优惠详情: ${tipsHtml}</div>
            `;

            // 6. 将订单添加到数组（用于历史展示）
            orders.push({
                name: customerName,
                price: price,
                qty: quantity,
                baseTotal: baseTotal,
                finalTotal: finalTotal,
                isVip: isVip,
                isUrgent: isUrgent,
                hitTimeDiscount: hitTimeDiscount
            });

            // 同步更新销售看板和历史订单表格
            renderDashboard();
        }

        // 五、销售看板与历史订单展示
        function renderDashboard() {
            var count = orders.length;
            var totalSales = 0;
            // 循环累加销售总额
            for (var i = 0; i < orders.length; i++) {
                totalSales += orders[i].finalTotal;
            }
            // 计算平均客单价（避免除以0）
            var avg = count > 0 ? totalSales / count : 0;

            // 显示销售看板数据
            document.getElementById("dashboard").innerHTML = `
                <p>订单数: ${count}</p>
                <p>销售总额: ¥${totalSales.toFixed(2)}</p>
                <p>平均客单价: ¥${avg.toFixed(2)}</p>
            `;

            // 组装历史订单表格HTML（修复原文标签错误）
            var tableHtml = `
                <table>
                    <tr>
                        <<th>客户名称</</th>
                        <<th>单价</</th>
                        <<th>数量</</th>
                        <<th>基础金额</</th>
                        <<th>最终金额</</th>
                        <<th>VIP</</th>
                        <<th>加急</</th>
                        <<th>时段折扣</</th>
                    </tr>
            `;
            // 循环渲染每个订单
            for (var j = 0; j < orders.length; j++) {
                var o = orders[j];
                tableHtml += `
                    <tr>
                        <td>${o.name}</td>
                        <td>¥${o.price.toFixed(2)}</td>
                        <td>${o.qty}</td>
                        <td>¥${o.baseTotal.toFixed(2)}</td>
                        <td>¥${o.finalTotal.toFixed(2)}</td>
                        <td>${o.isVip ? "是" : "否"}</td>
                        <td>${o.isUrgent ? "是" : "否"}</td>
                        <td>${o.hitTimeDiscount ? "是" : "否"}</td>
                    </tr>
                `;
            }
            tableHtml += "</table>";

            // 显示历史订单表格
            document.getElementById("orderTable").innerHTML = tableHtml;
        }

        // 页面加载时初始化销售看板（空数据状态）
        renderDashboard();
    </script>
</body>
</html>
